<%- include('partials/loggedInHeader') -%>

<main class="break-page">
    <h1>time to take a break</h1>
    <p>
        you just completed a focus session with
        <strong><%= partnerName %></strong>
    </p>
    <p>take 5 minutes to stretch, breathe, and reset away from your screen.</p>
    <p>don't forget to hydrate and move your body!</p>

    <div id="timer" class="timer">5:00</div>

    <div id="breakActions" style="display: none; margin-top: 16px;">
        <p>your break is over. what would you like to do?</p>

        <button id="stayBtn" class="btn">continue with the same partner</button>
        <button id="newBtn" class="btn">find a new partner</button>
    </div>
</main>

<%- include ('partials/footer') -%>

<script src="/socket.io/socket.io.js"></script>
<script>
    const timerEl = document.getElementById("timer");
    const breakActions = document.getElementById("breakActions");
    const socket = io();

    const roomId = "<%= roomId %>";
    const partnerName = "<%= partnerName %>";
    const myMode = "<%= mode %>"; // "video" or "text"

    console.log("break page roomId:", roomId, "mode:", myMode);

    let breakSeconds = .5 * 60;

    function updateBreakTimer() {
        const mins = String(Math.floor(breakSeconds / 60)).padStart(2, "0");
        const secs = String(breakSeconds % 60).padStart(2, "0");
        timerEl.textContent = `${mins}:${secs}`;

        if (breakSeconds <= 0) {
            breakActions.style.display = "block";
        } else {
            breakSeconds--;
        }
    }

    updateBreakTimer();
    setInterval(updateBreakTimer, 1000);

    // Buttons
    document.getElementById("stayBtn").addEventListener("click", () => {
        socket.emit("breakChoice", { roomId, choice: "stay" });
    });

    document.getElementById("newBtn").addEventListener("click", () => {
        socket.emit("breakChoice", { roomId, choice: "new" });
    });

    // Server result handler
    socket.on("breakResult", ({ action }) => {
        console.log("breakResult:", action);

        if (action === "new") {
            // either one or both chose "new"
            window.location.href = "/match";
        } else if (action === "stay") {
            // both chose "stay" â†’ go back to the mode we came from
            if (myMode === "video") {
                window.location.href =
                    `/videoChat/${roomId}?partnerName=${encodeURIComponent(partnerName)}&isCaller=false`;
            } else {
                window.location.href =
                    `/textChat/${roomId}?partnerName=${encodeURIComponent(partnerName)}`;
            }
        }
    });
</script>