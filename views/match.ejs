<%- include('partials/loggedInHeader') -%>

<main class="match-page">
    <div class="card" style="text-align: center; padding: 50px;">
    <h1>finding your BODY/DOUBLE...</h1>
    <p id="status">connecting you with a partner who matches your prefrences</p>
    </div>
</main>

<%- include('partials/footer') -%>
<script>
    //socket.io client
    const socket = io();

    const statusEl = document.getElementById("status");

    //user + filter info from server
    const userInfo = {
        userId: "<%= user._id %>",
        userName: "<%= user.userName %>",
        camera: "<%= filters.camera %>",
        workType: <%- JSON.stringify(filters.workType || []) %>
    };

    // Attach mode for server reference
    userInfo.mode = userInfo.camera === "on" ? "video" : "text";

    //ask server to find a match
    socket.emit("lookingForMatch", userInfo);

    socket.on("waiting", () => {
        statusEl.textContent = "waiting for another user to join...";
    });

    socket.on("matchFound", ({ roomId, partner, isCaller }) => {
        const myCamera = "<%= filters.camera %>"; //on or off

        statusEl.innerHTML = `
            matched with <strong>${partner.userName}</strong><br><br>
            <button id="enterRoomBtn" style="
                padding: 12px 24px;
                background: #bfa0fe;
                border: none;
                border-radius: 12px;
                font-size: 20px;
                cursor: pointer;
                font-weight: bold;
            ">
                enter room
            </button>
        `;

        document.getElementById("enterRoomBtn").addEventListener("click", () => {
            if (myCamera === "on") {
                window.location.href =
                `/videoChat/${roomId}?partnerName=${encodeURIComponent(partner.userName)}&isCaller=${isCaller}`;
            } else {
                window.location.href = 
                `/textChat/${roomId}?partnerName=${encodeURIComponent(partner.userName)}`;
            }
        });
    });
</script>
